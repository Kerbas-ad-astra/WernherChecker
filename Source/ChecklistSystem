using System;
using System.Text;
using System.Reflection;
using System.Collections.Generic;
using System.Linq;
using UnityEngine;

namespace WernherChecker
{
    public class ChecklistSystem
    {
        public WernherChecker MainInstance
        {
            get { return WernherChecker.Instance; }
        }

        public List<Checklist> availableChecklists = new List<Checklist>();
        public Checklist activeChecklist;
        public Rect paramsWindow = new Rect(0, 0, 200, 0);
        public static Rect paramEditor = new Rect(0, 0, 200, 20);
        public List<Part> partsToCheck;

        //GUIStyles
        public static GUIStyle normalLabel = new GUIStyle(HighLogic.Skin.label);
        public static GUIStyle orangeLabel = new GUIStyle(HighLogic.Skin.label) { normal = { textColor = new Color(1f, 0.5f, 0.2f) } };
        public static GUIStyle centredLabel = new GUIStyle(HighLogic.Skin.label) { alignment = TextAnchor.MiddleCenter };
        

        public bool LoadChecklists()
        {
            try
            {
                if (WernherChecker.Instance.Settings.cfgLoaded)
                {
                    availableChecklists.Clear();
                    foreach (ConfigNode checklistNode in WernherChecker.Instance.Settings.cfg.GetNodes("CHECKLIST"))
                    {
                        Debug.Log("[WernherChecker]: Parsing checklist - " + checklistNode.GetValue("name"));
                        Checklist parsedChecklist = new Checklist();
                        parsedChecklist.items = new List<ChecklistItem>();
                        parsedChecklist.name = checklistNode.GetValue("name");

                        ///Begining item cycle
                        foreach (ConfigNode itemNode in checklistNode.GetNodes("CHECKLIST_ITEM"))
                        {
                            //Debug.Log("parsing item " + itemNode.GetValue("name"));
                            ChecklistItem parsedItem = new ChecklistItem();
                            parsedItem.criteria = new List<Criterion>();
                            parsedItem.name = itemNode.GetValue("name");
                            bool.TryParse(itemNode.GetValue("isManual"), out parsedItem.isManual);

                            //Begining criterion cycle
                            foreach (ConfigNode criterionNode in itemNode.GetNodes("CRITERION"))
                            {
                                //Debug.Log("parsing criterion of type " + criterionNode.GetValue("type"));
                                Criterion parsedCriterion = new Criterion((CriterionType)Enum.Parse(typeof(CriterionType), criterionNode.GetValue("type")));
                                if (criterionNode.HasValue("defaultParameter"))
                                {
                                    int i;
                                    if (int.TryParse(criterionNode.GetValue("defaultParameter"), out i))
                                    {
                                        parsedCriterion.parameter = criterionNode.GetValue("defaultParameter");
                                        parsedCriterion.tempParam = parsedCriterion.parameter;
                                    }
                                }
                                switch (parsedCriterion.type)
                                {
                                    case CriterionType.Module:
                                        parsedCriterion.modules = criterionNode.GetValue("modules").Trim().Split(',').ToList<string>();
                                        break;

                                    case CriterionType.Part:
                                        parsedCriterion.parts = criterionNode.GetValue("parts").Trim().Split(',').ToList<string>();
                                        break;

                                    case CriterionType.MinResourceLevel:
                                    case CriterionType.MinResourceCapacity:
                                        parsedCriterion.resourceName = criterionNode.GetValue("resourceName");
                                        break;
                                    case CriterionType.ContractRequirements:
                                        break;
                                }
                                parsedItem.criteria.Add(parsedCriterion);
                            }
                            parsedChecklist.items.Add(parsedItem);
                        }
                        availableChecklists.Add(parsedChecklist);
                    }
                }
                return true;
            }

            catch
            {
                Debug.LogWarning("[WernherChecker]: Error loading checklist. Please, check your cfg file.");
                return false;
            }
        }

        public void CheckVessel(ShipConstruct ship)
        {
            if (MainInstance.checkSelected && MainInstance.partSelection != null)
                partsToCheck = MainInstance.partSelection.selectedParts;
            else
                partsToCheck = ship.Parts;

            if (!MainInstance.checklistSelected)
                return;

            for (int j = 0; j < activeChecklist.items.Count; j++)
            //foreach (ChecklistItem item in activeChecklist.items)
            {
                ChecklistItem item = activeChecklist.items[j];
                if (item.isManual)
                    continue;
                item.state = true;
                for (int i = 0; i < item.criteria.Count; i++)
                //foreach(Criterion crton in item.criteria)
                {
                    Criterion crton = item.criteria[i];
                    switch (crton.type)
                    {
                        case CriterionType.Module:
                            crton.met = CheckForModules(crton);
                            break;
                        case CriterionType.Part:
                            crton.met = CheckForParts(crton);
                            break;
                        case CriterionType.MinResourceLevel:
                            crton.met = CheckForResourceLevel(crton);
                            break;
                        case CriterionType.MinResourceCapacity:
                            crton.met = CheckForResourceCapacity(crton);
                            break;
                    }
                    item.criteria[i] = crton;

                    if (!crton.met)
                    {
                        item.state = false;
                        goto continueItemLoop;
                    }
                }

            continueItemLoop:
                activeChecklist.items[j] = item;
                continue;
            }
        }

        bool CheckForModules(Criterion crton)
        {
            int quantity = 0;
            foreach (string module in crton.modules)
            {
                quantity += partsToCheck.Where(p => p.Modules.Contains(module) && EditorLogic.SortedShipList.Contains(p)).Count();
            }
            if (quantity >= int.Parse(crton.parameter.ToString()))
                return true;

            return false;
        }

        bool CheckForParts(Criterion crton)
        {
            int quantity = 0;
            foreach (string part in crton.parts)
            {
                quantity += partsToCheck.Where(p => p.name == part && EditorLogic.SortedShipList.Contains(p)).Count();
            }
            if (quantity >= int.Parse(crton.parameter.ToString()))
                return true;

            return false;
        }

        bool CheckForResourceLevel(Criterion crton)
        {
            double quantity = 0;
            foreach (Part part in partsToCheck.Where(p => p.Resources.Contains(crton.resourceName)))
            {
                quantity += part.Resources.list.Find(r => r.resourceName == crton.resourceName && EditorLogic.SortedShipList.Contains(r.part)).amount;
            }
            if (quantity >= int.Parse(crton.parameter.ToString()))
                return true;

            return false;
        }

        bool CheckForResourceCapacity(Criterion crton)
        {
            double quantity = 0;
            foreach (Part part in partsToCheck.Where(p => p.Resources.Contains(crton.resourceName)))
            {
                quantity += part.Resources.list.Find(r => r.resourceName == crton.resourceName && EditorLogic.SortedShipList.Contains(r.part)).maxAmount;
            }
            if (quantity >= int.Parse(crton.parameter.ToString()))
                return true;

            return false;
        }


        public void DrawParamsWindow(int WindowID)
        {
            ChecklistItem item = activeChecklist.items.Find(p => p.paramsDisplayed);
            GUILayout.BeginVertical(GUILayout.Width(200));
            GUILayout.BeginHorizontal(GUILayout.ExpandHeight(false));
            GUILayout.Label("Item: " + item.name);
            GUILayout.FlexibleSpace();
            GUILayout.Label("â–º");
            GUILayout.EndHorizontal();
            item.criteria.ForEach(c => c.tempParam = c.paramsGUIAction(c));
            /*for (int i = 0; i < item.criteria.Count; i++)
            {
                Criterion crton = activeChecklist.items.Find(p => p.paramsDisplayed).criteria[i];
                crton.tempParam = crton.paramsGUIAction(crton);
                activeChecklist.items[activeChecklist.items.FindIndex(p => p.paramsDisplayed)].criteria[i] = crton;
            }*/
            if (item.criteria.TrueForAll(c => c.paramValid))
            {
                if (GUILayout.Button("Done", HighLogic.Skin.button))
                {
                    item.paramsDisplayed = false;
                    item.criteria.ForEach(c => c.parameter = c.tempParam);
                    /*for (int i = 0; i < item.criteria.Count; i++)
                    {
                        item.criteria[i].parameter = item.criteria[i].tempParam;
                    }*/
                    CheckVessel(EditorLogic.fetch.ship);
                }
            }
            else
            {
                GUILayout.Label("<color=#FF1111FF><b> ! Some paramaters are invalid !</b></color>", centredLabel);
            }
            activeChecklist.items[activeChecklist.items.IndexOf(item)] = item;
            GUILayout.EndVertical();
        }

        public static object ParamsTextField(Criterion crton)
        {
            int i;
            if (int.TryParse(crton.tempParam.ToString(), out i))
                crton.paramValid = true;
            else
                crton.paramValid = false;
            GUILayout.BeginHorizontal();
            GUILayout.Label(crton.type.ToString() + " QTY", crton.paramValid ? normalLabel : orangeLabel);
            GUILayout.FlexibleSpace();
            crton.tempParam = GUILayout.TextField(crton.tempParam.ToString(), 11, HighLogic.Skin.textField, GUILayout.Width(68f));
            GUILayout.EndHorizontal();
            
            return crton.tempParam;
        }

        /*public static object ParamsContractSelect(Criterion crton)
        {
            if (Contracts.ContractSystem.Instance.GetCurrentActiveContracts<Contracts.Contract>().Count() == 0)
                return null;

            GUILayout.Label(crton.type.ToString(), normalLabel);
            GUILayout.FlexibleSpace();
            if (GUILayout.Button(Contracts.ContractSystem.Instance.GetCurrentActiveContracts<Contracts.Contract>().First<Contracts.Contract>().Title, HighLogic.Skin.button))
            {
                //GUILayout.BeginArea(paramInspector, "Select Parameter", HighLogic.Skin.window);
                foreach (Contracts.Contract contract in Contracts.ContractSystem.Instance.GetCurrentActiveContracts<Contracts.Contract>().Where(c => c.AllParameters.Any(p => p.GetType() == typeof(Contracts.Parameters.PartTest) || p.GetType() == typeof(FinePrint.Contracts.Parameters.CrewCapacityParameter) || p.GetType() == typeof(FinePrint.Contracts.Parameters.PartRequestParameter))))
                    Debug.Log(contract.Title);
            }
            return crton.tempParam;
        }*/
    }
}
